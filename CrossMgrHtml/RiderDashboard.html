<!DOCTYPE html>
<html>
<!--
	Html Template for Race Animation.
	Generated from CrossMgr software.
	Copyright 2011-2014, Edward Sitarski
	For details, see sites.google.com/site/CrossMgrSoftware
-->
<head>
<meta charset="UTF-8" author="Edward Sitarski" copyright="Edward Sitarski, 2011-2014" generator="CrossMgr" />  
<title id="idTitle">TTIITTLLEE</title>	<!-- Don't change this text! -->
<style type="text/css">
body { font-family: sans-serif; }

.hidden { display: none; }

div label input {
   margin-right:220px;
}

select {
	font-size: 110%;
}

@media print { .noprint { display: none; } }

</style>
</head>

<script type="text/javascript" src="https://www.google.com/jsapi?autoload={'modules':[{'name':'visualization',
       'version':'1','packages':['table', 'corechart', 'timeline',]}]}"></script>
       
<script type="text/javascript">
google.setOnLoadCallback(onLoad);

var payload = null;
var bib = null;
var data = null;
var catDetails = null;
var raceName = null;

//-----------------------------
var bibRef = null;
var categoryCur = null;

//-----------------------------
// Convenience function to get the last element in an array.
Array.prototype.back = function() {
	return this[this.length-1];
};

function byte2Hex(n) {
	var nybHexString = "0123456789ABCDEF";
	return String(nybHexString.substr((n >> 4) & 0x0F,1)) + nybHexString.substr(n & 0x0F,1);
}

function RGB2Color(r,g,b) {
	return '#' + byte2Hex(r) + byte2Hex(g) + byte2Hex(b);
}

function makeColorGradient(frequency1, frequency2, frequency3,
                             phase1, phase2, phase3,
                             center, width, len)
{
	if (len == undefined)      len = 50;
	if (center == undefined)   center = 128;
	if (width == undefined)    width = 127;

	var grad = [];
	for (var i = 0; i <= len; ++i)
	{
		var red = Math.sin(frequency1*i + phase1) * width + center;
		var grn = Math.sin(frequency2*i + phase2) * width + center;
		var blu = Math.sin(frequency3*i + phase3) * width + center;
		grad.push( RGB2Color(red,grn,blu) );
	}
	return grad.slice(1);  // Skip the first pink colour.
}

var colors = makeColorGradient(2.4,2.4,2.4,0,2,4,128,127,500);

var catList = [];
function dataProlog() {
	if( payload ) { for( v in payload ) window[v] = payload[v]; payload = null; }
	
	// Find all the categories that this rider was ranked in.
	categoryCur = null;
	for( var i = 0; i < catDetails.length; ++i ) {
		if( catDetails[i].name == 'All' )
			continue;
		
		var cat = catDetails[i];
		for( var p = 0; p < cat.pos.length; ++p ) {
			if( cat.pos[p] == bib ) {
				cat.place = (p+1) + '/' + cat.pos.length;
				cat.iCat = i;
				catList.push( cat );
				if( !categoryCur || cat.pos.length < categoryCur.pos.length )
					categoryCur = cat;
				break;
			}
		}
	}
	catList.sort( function(x, y) { return x.pos.length - y.pos.length || x.iCat - y.iCat; } );
	
	document.getElementById( 'idRaceName' ).innerHTML = raceName;
}

function GetName( bib ) {
	var d = data[bib];
	if( !d )	return '';
	if( d.LastName && d.FirstName )	return d.FirstName + ' ' + d.LastName;
	if( d.LastName ) return d.LastName;
	return d.FirstName;
}

function GetBibName( bib ) {
	return bib + ': ' + GetName(bib);
}

function GetDateFromSecs( t ) {
	var secs = ~~t;
	var h = ~~(secs / (60*60));
	var m = (~~(secs / 60) % 60);
	var s = ~~(secs % 60);
	var ms = (t - secs) * 1000.0;
	return new Date( 0, 0, 0, h, m, s, ms );
}

function FormatTimeHMS( t, highPrecision )
{
	var tStr = '';
	if( t < 0 )
	{
		tStr = '-';
		t = -t;
	}
	var secs = ~~t;
	var h = ~~(secs / (60*60));
	var m = (~~(secs / 60) % 60);
	var s = (~~(secs % 60) + t - secs).toFixed( highPrecision ? 3 : 0 );
	if( h > 0 )
		tStr += h + 'h ' + m + 'm ' + s + 's';
	else
		tStr += m + 'm ' + s + 's';
	return tStr;
}

function FormatTime( t, highPrecision )
{
	var tStr = '';
	if( t < 0 )
	{
		tStr = '-';
		t = -t;
	}
	var secs = ~~t;
	var h = ~~(secs / (60*60));
	var m = (~~(secs / 60) % 60);
	var s = (~~(secs % 60) + t - secs).toFixed( highPrecision ? 3 : 0 );
	if( h > 0 )
		tStr += h + (m < 10 ? ':0' : ':') + m + (s < 10 ? ':0' : ':') + s;
	else
		tStr += m + (s < 10 ? ':0' : ':') + s;
	return tStr;
}

function FormatTimeGap( t, highPrecision )
{
	var tStr = '';
	if( t < 0 )
	{
		tStr = '-';
		t = -t;
	}
	var secs = ~~t;
	var h = ~~(secs / (60*60));
	var m = (~~(secs / 60) % 60);
	var s = (~~(secs % 60) + t - secs).toFixed( highPrecision ? 3 : 0 );
	if( h > 0 )
		tStr += h + (m < 10 ? 'h0' : 'h') + m + (s < 10 ? "'0" : "'") + s;
	else
		tStr += m + (s < 10 ? "'0" : "'") + s;
	tStr += '"';
	return tStr;
}

function updateCategories() {
	var categorySelect = document.getElementById( 'idCategorySelect' );
	categorySelect.innerHTML = '';
	categoryCur = null;
	for( var i = 0; i < catList.length; ++i ) {
		var cat = catList[i];
		if( !categoryCur )
			categoryCur = cat;
		var op = document.createElement( 'option' );
		op.value = i;
		op.text = cat.name;
		op.selected = (cat == categoryCur ? true : false);
		categorySelect.add( op );
	}
	updateCompare();
}

function updateCategoryResults() {
	var d = data[bib];
	var cr = [];
	for( var i = 0; i < catList.length; ++i ) {
		cr.push( '<strong>' + catList[i].place + '</strong> in ' + catList[i].name );
	}
	cr.push( '<br/><br/>' );
	if( d.status == 'Finisher' && d.raceTimes && d.raceTimes.length >= 2 ) {
		var s = 'Finished in ' + FormatTimeHMS(d.raceTimes.back() - d.raceTimes[0], true);
		if( d.speed )
			s += ' at ' + d.speed;
		cr.push( s );
	}
	else if( d.status != 'Finisher' )
		cr.push( d.status );
	document.getElementById( 'idCategoryResults' ).innerHTML = 'Placed: ' + cr.join('&nbsp;&nbsp;&nbsp;');
}

function categorySelectChange( select ) {
	categoryCur = categoryList[select.options[select.selectedIndex].value];
	updateCompare();
	updateCompareDisplays();
}

function updateCompare() {
	var categorySelect = document.getElementById( 'idCategorySelect' );
	var compareSelect = document.getElementById( 'idCompareSelect' );
	compareSelect.innerHTML = '';
	bibRef = null;
	var iBib = null;
	for( var i = 0; i < categoryCur.pos.length; ++i ) {
		var bibCur = categoryCur.pos[i];
		if( bibCur == bib ) {
			iBib = i;
			continue;
		}
		if( !bibRef )
			bibRef = bibCur;
		var d = data[bibCur];
		if( !(d.raceTimes && d.raceTimes.length >= 2) )
			continue;
		if( !(i < 20 || (iBib != null && (iBib-3 < i || i < iBib+2))) )
			continue;
		var op = document.createElement( 'option' );
		op.value = bibCur;
		op.text = (i+1) + '.  ' + GetName(bibCur);
		compareSelect.add( op );
	}
}

function compareSelectChange( select ) {
	bibRef = null;
	if( select.options.length )
		bibRef = select.options[select.selectedIndex].value;
	updateCompareDisplays();
}

function updateLapTable() {
	var container = document.getElementById( 'idLapTable' );
	if( !container.table )
		container.table = new google.visualization.Table( container );
	
	var d = data[bib];
	
	var dataTable = new google.visualization.DataTable();
	dataTable.addColumn( 'number', 'Lap' );
	dataTable.addColumn( 'number', 'Lap Time' );
	dataTable.addColumn( 'number', 'Race Time' );
	if( d.speed )
		dataTable.addColumn( 'number', 'Lap Speed' + ' (' + d.speed.split(' ')[1] + ')' );
	
	for( var r = 1; r < d.raceTimes.length; ++r ) {
		var lapTime = d.raceTimes[r] - d.raceTimes[r-1];
		var raceTime = d.raceTimes[r] - d.raceTimes[0];
		var row = [r, { v:lapTime, f:FormatTime(lapTime, true) }, { v:raceTime, f:FormatTime(raceTime, true) }];
		if( d.speed )
			row.push( { v:d.lapSpeeds[r-1], f:d.lapSpeeds[r-1].toFixed(2) } );
		dataTable.addRow( row );
	}
	container.table.draw( dataTable );
}

function GetGap( bib, bibRef ) {
	var d = data[bib], dRef = data[bibRef];
	if( !d || !dRef || !d.raceTimes || !dRef.raceTimes || d.raceTimes.length==0 || dRef.raceTimes.length==0 )
		return {v:0, f:''};
	if( d.raceTimes.length != dRef.raceTimes.length ) {
		var lapsDown = dRef.raceTimes.length - d.raceTimes.length;
		return {v:lapsDown*1000.0*60.0*60.0, f:-lapsDown + (Math.abs(lapsDown) > 1 ? ' laps' : ' lap') + (lapsDown < 0 ? ' more' : '')};
	}
	var g = (d.raceTimes.back() - d.raceTimes[0]) - (dRef.raceTimes.back() - dRef.raceTimes[0]);
	return {v:g, f:FormatTimeGap(g)};
}
function GetPlace( bib ) {
	for( var i = 0; i < categoryCur.pos.length; ++i )
		if( categoryCur.pos[i] == bib )
			return {v:i, f:(i+1) + '/' + categoryCur.pos.length};
	return '';
}
function GetTime( bib ) {
	var d = data[bib];
	if( !d || !d.raceTimes || !d.raceTimes.length )
		return {v:0, f:''};
	var t = d.raceTimes.back() - d.raceTimes[0];
	return {v:t, f:FormatTime(t, true) };
}

function GetEstimatedLapTime( bib ) {
	var d = data[bib];
	if( !d || !d.raceTimes || d.raceTimes.length < 2 )
		return 99999999999;
	if( d.raceTimes > 2 )
		return (d.raceTimes.back() - d.raceTimes[1]) / (d.raceTimes.length-2);
	return (d.raceTimes.back() - d.raceTimes[0]) / (d.raceTimes.length-1);
}

function GetPercentComparison( bib, bibRef ) {
	var d = data[bib], dRef = data[bibRef];
	if( !d || !dRef || !d.raceTimes || !dRef.raceTimes || d.raceTimes.length < 2 || dRef.raceTimes.length < 2 )
		return {v:0, f:''};
	var t = d.raceTimes.back() - d.raceTimes[0], tRef = dRef.raceTimes.back() - dRef.raceTimes[0];
	if( d.raceTimes.length < dRef.raceTimes.length )
		t += GetEstimatedLapTime(bib) * (dRef.raceTimes.length - d.raceTimes.length);
	else if( d.raceTimes.length > dRef.raceTimes.length )
		tRef += GetEstimatedLapTime(bibRef) * (d.raceTimes.length - dRef.raceTimes.length);
	var p = 1.0 - t/tRef;
	return {v:p, f:(p == 0 ? '' : (Math.abs(p)*100).toFixed(1) + (p<0 ? '% slower' : p>0 ? '% faster' : ''))};
}

function updateInfoTable() {
	var container = document.getElementById( 'idInfoTable' );
	if( !container.table )
		container.table = new google.visualization.Table( container );
	
	var d = data[bib];
	
	var dataTable = new google.visualization.DataTable();
	dataTable.addColumn( 'string', 'Name' );
	dataTable.addColumn( 'number', 'Place' );
	dataTable.addColumn( 'number', 'Time' );
	dataTable.addColumn( 'number', 'Gap' );
	if( d.speed )
		dataTable.addColumn( 'number', 'Avg Speed' + ' (' + d.speed.split(' ')[1] + ')' );
	dataTable.addColumn( 'number', 'Comparison' );
	
	for( var i = 0; i < 2; ++i ) {
		var bibCur = (i == 0 ? bib : bibRef);
		var gap = (i != 0 ? {v:0,f:''} : GetGap(bib, bibRef));
		var riderName = GetName(bibCur);
		var d = data[bibCur];
		var row = [ GetName(bibCur), GetPlace(bibCur), GetTime(bibCur), gap];
		if( d.speed ) {
			var s = parseFloat(d.speed.split(' ')[0]);
			row.push( {v:s, f:s.toFixed(2)} );
		}
		row.push( GetPercentComparison(bibCur, bibRef) );
		dataTable.addRow( row );
	}

	container.table.draw( dataTable );
}

function updateGanttChart() {
	var container = document.getElementById( 'idGanttChart' );
	if( !container.chart )
		container.chart = new google.visualization.Timeline( container );
	
	var dataTable = new google.visualization.DataTable();
	dataTable.addColumn( 'string', 'Rider' );
	dataTable.addColumn( 'string', 'Lap' );
	dataTable.addColumn( 'date', 'Start' );
	dataTable.addColumn( 'date', 'End' );
	
	var maxLaps = 0;
	for( var i = 0; i < 2; ++i ) {
		var bibCur = (i == 0 ? bib : bibRef);
		var riderName = GetName(bibCur);
		var d = data[bibCur];
		if( !d.raceTimes )
			continue;
		var tLast = 0.0
		maxLaps = Math.max( maxLaps, d.raceTimes.length );
		for( var r = 1; r < d.raceTimes.length; ++r ) {
			var tNext = tLast + d.raceTimes[r] - d.raceTimes[r-1];
			dataTable.addRow( [
				riderName,
				'Lap ' + r,
				GetDateFromSecs(tLast),
				GetDateFromSecs(tNext)] );
			tLast = tNext;
		}
	}
	
	var options = {
		colors: colors.slice( maxLaps+1 ),
	};
	container.chart.draw( dataTable, options );
}

function updateLapTimesChart() {
	var container = document.getElementById( 'idLapTimesChart' );
	if( !container.chart )
		container.chart = new google.visualization.LineChart( container );
	
	var dataTable = new google.visualization.DataTable();
	dataTable.addColumn( 'string', 'Lap' );
	dataTable.addColumn( 'number', GetName(bib) );
	if( bibRef )
		dataTable.addColumn( 'number', GetName(bibRef) );
	
	var dLeader = data[bibRef];
	var d = data[bib];
	for( var r = 1; r < d.raceTimes.length; ++r ) {
		var row = [
			'' + r,
			{	v:(r < d.raceTimes.length ? d.raceTimes[r] - d.raceTimes[r-1] : 0)/60.0,
				f:FormatTimeHMS(r < d.raceTimes.length ? d.raceTimes[r] - d.raceTimes[r-1] : 0)
			}
		];
		if( bibRef )
			row.push( {	v:(dLeader.raceTimes[r] - dLeader.raceTimes[r-1])/60.0,
						f:FormatTimeHMS(dLeader.raceTimes[r] - dLeader.raceTimes[r-1]) } );
		dataTable.addRow( row );
	}
	var options = {
		title: 'Lap Times',
		vAxis: {title: "minutes"},
		hAxis: {title: "lap"},
		colors: ['blue', '#8888FF'],
		pointSize: 5,
		chartArea: {left: '10%', width: '70%'},
		animation: {duration: 250},
	};
	container.chart.draw( dataTable, options );
}

function updateGapChart() {
	var container = document.getElementById( 'idGapChart' );
	if( !container.chart )
		container.chart = new google.visualization.LineChart( container );
	
	var dataTable = new google.visualization.DataTable();
	dataTable.addColumn( 'string', 'Lap' );
	dataTable.addColumn( 'number', 'Gap' );
	
	var dLeader = data[bibRef];
	var d = data[bib];
	for( var r = 1; r < d.raceTimes.length; ++r ) {
		var ab = bibRef ? (d.raceTimes[r] - d.raceTimes[0]) - (dLeader.raceTimes[r] - dLeader.raceTimes[0]) : 0.0;
		dataTable.addRow( [ '' + r, {v: ab/60.0, f: FormatTimeHMS(ab)} ] );
	}
	var options = {
		title: 'Gap: ' + GetName(bib) + ' \u21E8 ' + GetName(bibRef),
		vAxis: {title: "minutes"},
		hAxis: {title: "lap"},
		colors: ['blue'],
		legend: 'none',
		pointSize: 5,
		chartArea: {left: '10%', width: '70%'},
		animation: {duration: 250},
	};
	container.chart.draw( dataTable, options );
}

function updateCompareDisplays() {
	updateInfoTable();
	updateGanttChart();
	updateLapTimesChart();
	updateGapChart();
}

function onLoad() {
	dataProlog();
	var d = data[bib];
	document.getElementById('idHeader').innerHTML = GetBibName(bib) + (d.Team ? ' (' + d.Team + ')' : '');
	updateCategoryResults();
	updateCategories();
	updateLapTable();
	updateCompareDisplays();
}
</script>
<body>
<h1 id="idHeader"></h1>
<h4 id="idRaceName">Race Name</h4>
<p id="idCategoryResults">Category Results</p>
<div id="idLapTable" style="width: 420px; height: 190px;"></div>
<br/>
Category:&nbsp;<select id="idCategorySelect" onchange="categorySelectChange(this)"></select>&nbsp;&nbsp;&nbsp;&nbsp;Compare&nbsp;to:&nbsp;<select id="idCompareSelect" onchange="compareSelectChange(this)"></select>
<br/><br/>
<div id="idInfoTable" style="width: 720px; height: 80px;"></div>
<br/>
<div id="idGanttChart" style="width: 720px; height: 136px;"></div>
<div id="idLapTimesChart" style="width: 900px; height: 180px;"></div>
<div id="idGapChart" style="width: 900px; height: 180px;"></div>
<a href="http://www.sites.google.com/site/crossmgrsoftware" target="_blank">Powered by CrossMgr</a>
</body>
</html>
